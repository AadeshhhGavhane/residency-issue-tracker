<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Residential Society Issue Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-home me-2"></i>Residential Society
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="report-issue.html">Report Issue</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="my-issues.html">My Issues</a>
                    </li>
                    <li class="nav-item" id="adminLink" style="display: none;">
                        <a class="nav-link" href="admin-dashboard.html">Admin Dashboard</a>
                    </li>
                    <li class="nav-item" id="technicianLink" style="display: none;">
                        <a class="nav-link" href="technician-dashboard.html">My Assignments</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <img id="userProfilePic" src="https://via.placeholder.com/32x32" alt="Profile" class="rounded-circle me-2" style="width: 32px; height: 32px;">
                            <span id="userName">User</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="profile.html">Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="auth.logout()">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <h1 class="display-4 mb-3">Welcome, <span id="userNameDisplay">User</span>!</h1>
                <p class="lead mb-4">Welcome to the Residential Society Issue Tracker. Report and track maintenance issues in your community.</p>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>Report Issues
                                </h5>
                                <p class="card-text">Report maintenance issues, security concerns, or any problems in your society.</p>
                                <a href="report-issue.html" class="btn btn-primary">Report Issue</a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-list text-info me-2"></i>Track Progress
                                </h5>
                                <p class="card-text" id="trackProgressText">Monitor the status of your reported issues and see when they're resolved.</p>
                                <a href="my-issues.html" class="btn btn-outline-primary" id="trackProgressBtn">My Issues</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-user-cog text-success me-2"></i>Profile Management
                                </h5>
                                <p class="card-text">Update your profile information and manage your account settings.</p>
                                <a href="profile.html" class="btn btn-outline-success">Edit Profile</a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-chart-bar text-primary me-2"></i>Analytics
                                </h5>
                                <p class="card-text">View community statistics and issue resolution metrics (Admin/Committee only).</p>
                                <div id="analyticsCardContent">
                                    <span class="badge bg-secondary">Admin Feature</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <img id="userProfilePicLarge" class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;" alt="Profile Picture">
                        <h5 id="userNameCard">User Name</h5>
                        <p class="text-muted" id="userRole">Resident</p>
                        <p class="text-muted" id="userEmail">user@example.com</p>
                        
                        <div class="mt-3">
                            <a href="profile.html" class="btn btn-outline-primary btn-sm me-2">Edit Profile</a>
                            <button class="btn btn-outline-secondary btn-sm" onclick="auth.logout()">Logout</button>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-info-circle text-info me-2"></i>Quick Stats
                        </h6>
                        <div id="quickStats">
                            <p class="text-muted">Loading statistics...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Issues Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-clock me-2"></i>Recent Issues
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="recentIssues">
                            <p class="text-muted">Loading recent issues...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/issues.js"></script>
    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Check authentication
                await auth.checkAuth();
                
                // Update user display
                updateUserDisplay();
                
                // Debug: Log user role for troubleshooting
                console.log('Current user role:', auth.currentUser?.role);
                console.log('Current user:', auth.currentUser);
                
                // Wait for modules to be fully loaded with retry mechanism
                let retryCount = 0;
                const maxRetries = 10; // Increased retries
                
                while (retryCount < maxRetries) {
                    if (typeof issues !== 'undefined' && issues.getIssues && typeof auth !== 'undefined' && auth.currentUser) {
                        console.log('All modules loaded successfully');
                        break;
                    }
                    console.log(`Waiting for modules to load... (attempt ${retryCount + 1}/${maxRetries})`);
                    await new Promise(resolve => setTimeout(resolve, 300)); // Increased delay
                    retryCount++;
                }
                
                if (retryCount >= maxRetries) {
                    console.warn('Some modules not loaded after retries, proceeding anyway');
                }
                
                // Load quick stats and recent issues
                await loadQuickStats();
                await loadRecentIssues();
            } catch (error) {
                console.error('Page initialization error:', error);
                // Show user-friendly error message
                const errorAlert = document.createElement('div');
                errorAlert.className = 'alert alert-warning alert-dismissible fade show';
                errorAlert.innerHTML = `
                    <i class="fas fa-exclamation-triangle me-2"></i>Some features may not be available. Please refresh the page if issues persist.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container').insertBefore(errorAlert, document.querySelector('.container').firstChild);
            }
        });

        function updateUserDisplay() {
            if (auth.currentUser) {
                // Update all user name displays
                const nameElements = document.querySelectorAll('#userName, #userNameDisplay, #userNameCard');
                nameElements.forEach(el => el.textContent = auth.currentUser.name);

                // Update email
                document.getElementById('userEmail').textContent = auth.currentUser.email;

                // Update role
                const roleElement = document.getElementById('userRole');
                const roleNames = {
                    'resident': 'Resident',
                    'committee': 'Committee Member',
                    'technician': 'Technician'
                };
                roleElement.textContent = roleNames[auth.currentUser.role] || 'User';

                // Update profile picture
                const profilePicElements = document.querySelectorAll('#userProfilePic, #userProfilePicLarge');
                if (auth.currentUser.profilePicture) {
                    profilePicElements.forEach(el => {
                        el.src = auth.currentUser.profilePicture;
                        el.style.display = 'block';
                    });
                } else {
                    profilePicElements.forEach(el => {
                        el.src = 'https://via.placeholder.com/150x150?text=No+Photo';
                        el.style.display = 'block';
                    });
                }

                // Show/hide role-specific navigation
                const adminLink = document.getElementById('adminLink');
                const technicianLink = document.getElementById('technicianLink');
                const myIssuesLink = document.querySelector('a[href="my-issues.html"]').parentElement;
                
                if (auth.currentUser.role === 'committee') {
                    adminLink.style.display = 'block';
                    
                    // Enable Analytics card for committee members
                    const analyticsCardContent = document.getElementById('analyticsCardContent');
                    if (analyticsCardContent) {
                        analyticsCardContent.innerHTML = `
                            <a href="admin-dashboard.html" class="btn btn-primary">View Analytics</a>
                        `;
                    }
                }
                if (auth.currentUser.role === 'technician') {
                    technicianLink.style.display = 'block';
                    myIssuesLink.style.display = 'none'; // Hide My Issues for technicians
                    
                    // Update Track Progress card for technicians
                    const trackProgressText = document.getElementById('trackProgressText');
                    const trackProgressBtn = document.getElementById('trackProgressBtn');
                    if (trackProgressText && trackProgressBtn) {
                        trackProgressText.textContent = 'Monitor your assigned tasks and track your progress on maintenance work.';
                        trackProgressBtn.textContent = 'My Assignments';
                        trackProgressBtn.href = 'technician-dashboard.html';
                    }
                    
                    // Update Quick Stats card for technicians
                    const quickStatsTitle = document.querySelector('#quickStats').closest('.card').querySelector('.card-title');
                    if (quickStatsTitle) {
                        quickStatsTitle.innerHTML = '<i class="fas fa-tasks text-info me-2"></i>Assignment Statistics';
                    }
                    
                    // Update Recent Issues card for technicians
                    const recentIssuesTitle = document.querySelector('#recentIssues').closest('.card').querySelector('.card-title');
                    if (recentIssuesTitle) {
                        recentIssuesTitle.innerHTML = '<i class="fas fa-clock me-2"></i>Recent Assignments';
                    }
                    
                    // Disable Analytics card for technicians
                    const analyticsCardContent = document.getElementById('analyticsCardContent');
                    if (analyticsCardContent) {
                        analyticsCardContent.innerHTML = `
                            <span class="badge bg-secondary">Admin Feature</span>
                            <small class="text-muted d-block mt-2">Technicians cannot access analytics</small>
                        `;
                    }
                }
                
                // Handle resident role
                if (auth.currentUser.role === 'resident') {
                    // Disable Analytics card for residents
                    const analyticsCardContent = document.getElementById('analyticsCardContent');
                    if (analyticsCardContent) {
                        analyticsCardContent.innerHTML = `
                            <span class="badge bg-secondary">Admin Feature</span>
                            <small class="text-muted d-block mt-2">Residents cannot access analytics</small>
                        `;
                    }
                }
            }
        }

        async function loadQuickStats() {
            try {
                // Check if issues module is available
                if (typeof issues === 'undefined' || !issues.getIssues) {
                    throw new Error('Issues module not loaded');
                }

                // Handle different roles
                if (auth.currentUser.role === 'technician') {
                    // For technicians, show assignment statistics instead
                    const response = await issues.getAssignments({ limit: 10 });
                    const { assignments } = response.data;

                    const statsContainer = document.getElementById('quickStats');
                    
                    const totalAssignments = assignments.length;
                    const completedAssignments = assignments.filter(assignment => assignment.status === 'completed').length;
                    const pendingAssignments = assignments.filter(assignment => assignment.status === 'accepted' || assignment.status === 'in_progress').length;

                    statsContainer.innerHTML = `
                        <div class="row text-center">
                            <div class="col-4">
                                <h4 class="text-primary">${totalAssignments}</h4>
                                <small class="text-muted">Total Tasks</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-success">${completedAssignments}</h4>
                                <small class="text-muted">Completed</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-warning">${pendingAssignments}</h4>
                                <small class="text-muted">Pending</small>
                            </div>
                        </div>
                    `;
                } else {
                    // For residents and committee, show general issue statistics
                    const response = await issues.getIssues({ limit: 5 });
                    const { issues: issuesList } = response.data;

                    const statsContainer = document.getElementById('quickStats');
                    
                    const totalIssues = issuesList.length;
                    const resolvedIssues = issuesList.filter(issue => issue.status === 'resolved' || issue.status === 'closed').length;
                    const pendingIssues = issuesList.filter(issue => issue.status === 'new' || issue.status === 'assigned' || issue.status === 'in_progress').length;

                    statsContainer.innerHTML = `
                        <div class="row text-center">
                            <div class="col-4">
                                <h4 class="text-primary">${totalIssues}</h4>
                                <small class="text-muted">Total Issues</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-success">${resolvedIssues}</h4>
                                <small class="text-muted">Resolved</small>
                            </div>
                            <div class="col-4">
                                <h4 class="text-warning">${pendingIssues}</h4>
                                <small class="text-muted">Pending</small>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Load quick stats error:', error);
                const statsContainer = document.getElementById('quickStats');
                
                if (auth.currentUser.role === 'technician') {
                    statsContainer.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-tasks fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-2">Unable to load assignment statistics</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="retryLoadStats()">Retry</button>
                        </div>
                    `;
                } else {
                    statsContainer.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-chart-bar fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-2">Unable to load statistics</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="retryLoadStats()">Retry</button>
                        </div>
                    `;
                }
            }
        }

        async function loadRecentIssues() {
            try {
                // Check if issues module is available
                if (typeof issues === 'undefined' || !issues.getIssues) {
                    throw new Error('Issues module not loaded');
                }

                // Handle different roles
                if (auth.currentUser.role === 'technician') {
                    // For technicians, show recent assignments instead
                    const response = await issues.getAssignments({ limit: 5 });
                    const { assignments } = response.data;

                    const container = document.getElementById('recentIssues');
                    
                    if (assignments.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-3">
                                <i class="fas fa-clipboard-list fa-2x text-muted mb-2"></i>
                                <p class="text-muted">No assignments yet</p>
                                <a href="technician-dashboard.html" class="btn btn-primary btn-sm">View My Assignments</a>
                            </div>
                        `;
                        return;
                    }

                    const assignmentsHtml = assignments.map(assignment => {
                        const date = assignment.assignedAt || assignment.createdAt;
                        const formattedDate = date ? issues.formatDate(date) : 'Unknown Date';
                        return `
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <h6 class="mb-1">${assignment.issue?.title || 'Unknown Issue'}</h6>
                                    <small class="text-muted">${assignment.issue?.category || 'General'} • ${formattedDate}</small>
                                </div>
                                <span class="badge ${issues.getStatusBadgeClass(assignment.status || 'pending')}">${(assignment.status || 'pending').replace('_', ' ').toUpperCase()}</span>
                            </div>
                        `;
                    }).join('');

                    container.innerHTML = assignmentsHtml;
                } else {
                    // For residents and committee, show recent issues
                    const response = await issues.getIssues({ limit: 5 });
                    const { issues: issuesList } = response.data;

                    const container = document.getElementById('recentIssues');
                    
                    if (issuesList.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-3">
                                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                <p class="text-muted">No issues reported yet</p>
                                <a href="report-issue.html" class="btn btn-primary btn-sm">Report Your First Issue</a>
                            </div>
                        `;
                        return;
                    }

                    const issuesHtml = issuesList.map(issue => `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <h6 class="mb-1">${issue.title}</h6>
                                <small class="text-muted">${issues.getCategoryDisplayName(issue.category)} • ${issues.formatDate(issue.createdAt)}</small>
                            </div>
                            <span class="badge ${issues.getStatusBadgeClass(issue.status)}">${issue.status.replace('_', ' ').toUpperCase()}</span>
                        </div>
                    `).join('');

                    container.innerHTML = issuesHtml;
                }
            } catch (error) {
                console.error('Load recent issues error:', error);
                const container = document.getElementById('recentIssues');
                
                if (auth.currentUser.role === 'technician') {
                    container.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-exclamation-triangle fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-2">Unable to load recent assignments</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="retryLoadIssues()">Retry</button>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-3">
                            <i class="fas fa-exclamation-triangle fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-2">Unable to load recent issues</p>
                            <button class="btn btn-outline-primary btn-sm" onclick="retryLoadIssues()">Retry</button>
                        </div>
                    `;
                }
            }
        }

        // Retry functions
        async function retryLoadStats() {
            await loadQuickStats();
        }

        async function retryLoadIssues() {
            await loadRecentIssues();
        }
    </script>
</body>
</html> 